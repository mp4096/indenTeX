language: rust
cache: cargo
sudo: false

matrix:
  include:
    # Stable
    - os: linux
      dist: trusty
      rust: stable
      addons:
        apt:
          packages:
            # Install libraries for coverage
            - binutils-dev
            - libcurl4-openssl-dev
            - libdw-dev
            - libelf-dev
            - libiberty-dev
    - os: osx
      rust: stable
    # Beta
    - os: linux
      dist: trusty
      rust: beta
    - os: osx
      rust: beta
    # Nightly
    - os: linux
      dist: trusty
      rust: nightly
    - os: osx
      rust: nightly
  allow_failures:
    - rust: nightly

before_script:
  - cargo --version --verbose
  - rustc --version --verbose
  # Fetch the big list of naughty strings
  - >
    wget -O ./tests/blns/blns.inden.tex
    https://raw.githubusercontent.com/minimaxir/big-list-of-naughty-strings/master/blns.txt
  # Configure only if we're doing coverage
  - >
    if [[ "$TRAVIS_OS_NAME" == "linux" ]] && [[ "$TRAVIS_RUST_VERSION" == "stable" ]]; then
      LOCAL="~/.local" && export PATH=$LOCAL/bin:$PATH;
    fi

script:
  - cargo build
  - cargo test
  - cargo run -- -v ./tests/
  - cargo run -- -v ./tests/empty_folder/  # Check how indentex handles empty folders
  - python ./tests/compare_to_reference.py

after_success: >
  if [[ "$TRAVIS_OS_NAME" == "linux" ]] && [[ "$TRAVIS_RUST_VERSION" == "stable" ]]; then
    wget https://github.com/SimonKagstrom/kcov/archive/v33.tar.gz &&
    tar xzf v33.tar.gz &&
    mkdir kcov-33/build &&
    cd kcov-33/build &&
    cmake -DCMAKE_INSTALL_PREFIX:PATH=$LOCAL .. &&
    make &&
    make install &&
    cd ../.. &&
    rm -rf kcov-33 &&
    RUSTFLAGS='-C link-dead-code' cargo test --no-run &&
    for file in target/debug/indentex-*; do
      if [[ "${file: -2}" != ".d" ]]; then
        mkdir -p "target/cov/$(basename $file)";
        kcov --exclude-pattern=/.cargo,/usr/lib --verify "target/cov/$(basename $file)" "$file";
      fi;
    done &&
    kcov --coveralls-id=$TRAVIS_JOB_ID --merge target/cov target/cov/*;
  fi


# Deploy to GitHub releases on tag builds
before_deploy:
  - cargo install --git https://github.com/mmstick/cargo-deb
  - cargo deb

deploy:
  provider: releases
  api_key:
      secure: "Bc3OYcPt8pvVqqippb1jcnqJI4V568LKcbDGO/UiESCmUmRHQ5eT3awwbdNzNVCp9S5i8yBzA7gkBT7NLkGdmalutysrmQ4N88LvMSoq6L3rksvu/VAwFq6ImZL/DXrdZOknK7Lh6NEOYDRJpcfv0lVdAIeTCxG/apwHxoPg6G97/A1n4Q9bLIoUPW6O4PWIowY/1zayQj8MevVKLWrdtMaxjeu1jYgRtVXkR6Q0kuWiFnsQGXkAGp98GIXu9Fk/whnzqg4r4Yqqm0JT6vxvLqylIFXICa0Zzuo8n60mNTZpD4GLc0Tnbzu7CtShC4YmiCE9uGAcmwTcRRl9pRyF/1Pq8WufDlw+SM9zUNV6WGbE/xciLi/m51mlDC1ZTkv4aMTl5ljshz05tAuBcoFC9KWSkv6/0b0b48osHaA1WKIK2eJ23EJwiWU3kfV0Sxihj4oeMHhItypLGn4806MVGnLxxuXwRg1r7an1rJdxxs+chINKk9yaR1fxG1OrIXxd+1SMPQMlkei6ECgCqCQ0kRg32nkA9hRvCpRRizvvxrJSB8WQiJUI+CpP7sjLzTAHO0ZYrRPsmERaPzv7GkopeIgJ5MERHhDtc8hRLEckkuR3mm64+9u0sUM+Dt2lWY2m5kf3YzkAfNLaDvwSNZPn8fzCNn+MbbKd+VoF+zdX0V4="
  file_glob: true
  file: "target/debian/indentex_*_amd64.deb"
  skip_cleanup: true
  on:
    condition: $TRAVIS_RUST_VERSION = stable
    tags: true
